<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>MiniPhone</title>
    <meta name="description" content="AI æ¨¡æ‹Ÿæ‰‹æœºèŠå¤©åº”ç”¨">
    <meta name="theme-color" content="#0a0a0a">
    <link rel="stylesheet" href="css/main.css?v=39">
    <!-- PWA -->
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="icons/icon-192.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="icons/icon-192.svg">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <script>
        // Register Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./service-worker.js')
                .then(reg => console.log('âœ… Service Worker æ³¨å†ŒæˆåŠŸ:', reg.scope))
                .catch(err => console.warn('âš ï¸ Service Worker æ³¨å†Œå¤±è´¥:', err));
        }
    </script>
    <script>
        window.onerror = function (msg, url, line, col, error) {
            if (msg.includes('ResizeObserver')) return;
            alert("JS Error: " + msg + "\nFile: " + url + "\nLine: " + line);
            console.error("JS Error:", msg, error);
        };
        window.addEventListener('unhandledrejection', function (event) {
            alert("Unhandled Promise Rejection: " + event.reason);
        });
    </script>
    <style>
        #login-overlay {
            position: fixed;
            inset: 0;
            z-index: 99999;
            background: #0a0a0a;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.4s;
        }

        #login-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .login-box {
            background: rgba(30, 30, 30, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 40px 32px;
            width: min(320px, 85vw);
            text-align: center;
            backdrop-filter: blur(20px);
        }

        .login-box h2 {
            color: #fff;
            font-size: 22px;
            margin: 0 0 8px;
            font-weight: 600;
        }

        .login-box p {
            color: rgba(255, 255, 255, 0.5);
            font-size: 13px;
            margin: 0 0 28px;
        }

        .login-box input {
            width: 100%;
            box-sizing: border-box;
            padding: 12px 16px;
            margin-bottom: 12px;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 10px;
            color: #fff;
            font-size: 15px;
            outline: none;
            transition: border-color 0.2s;
        }

        .login-box input:focus {
            border-color: rgba(255, 255, 255, 0.4);
        }

        .login-box input::placeholder {
            color: rgba(255, 255, 255, 0.3);
        }

        .login-box button {
            width: 100%;
            padding: 12px;
            margin-top: 8px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            border-radius: 10px;
            color: #fff;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.15s, opacity 0.15s;
        }

        .login-box button:active {
            transform: scale(0.97);
            opacity: 0.9;
        }

        .login-error {
            color: #ff6b6b;
            font-size: 13px;
            margin-top: 10px;
            min-height: 18px;
        }
    </style>
    <script type="module">
        console.log("Starting module load...");
        try {
            await import('./js/main.js?v=39');
            console.log("Module loaded successfully");
        } catch (e) {
            console.error("Module Load Failed:", e);
            // Auto-recovery: clear all caches and reload
            if ('serviceWorker' in navigator) {
                const regs = await navigator.serviceWorker.getRegistrations();
                for (const reg of regs) await reg.unregister();
                const keys = await caches.keys();
                for (const key of keys) await caches.delete(key);
                console.log('Caches cleared, reloading...');
                location.reload(true);
            } else {
                alert("æ¨¡å—åŠ è½½å¤±è´¥:\\n" + e.message + "\\n\\nè¯·æ¸…é™¤æµè§ˆå™¨ç¼“å­˜åé‡è¯•ã€‚");
            }
        }
    </script>
</head>

<body>
    <!-- Login Overlay -->
    <div id="login-overlay">
        <div class="login-box">
            <h2>ğŸ”’ MiniPhone</h2>
            <p>è¯·è¾“å…¥å‡­æ®ä»¥ç»§ç»­</p>
            <input type="text" id="login-user" placeholder="ç”¨æˆ·å" autocomplete="username">
            <input type="password" id="login-pass" placeholder="å¯†ç " autocomplete="current-password">
            <button id="login-btn">ç™»å½•</button>
            <div class="login-error" id="login-error"></div>
        </div>
    </div>
    <script>
        (function () {
            const HASH = 'b4f39b221c19a791572d1028635cdcac838c408a3c259ae9a74d2b48f870263f';
            const overlay = document.getElementById('login-overlay');

            if (sessionStorage.getItem('mp_auth') === HASH) {
                overlay.style.display = 'none';
                return;
            }

            async function sha256(str) {
                const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(str));
                return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2, '0')).join('');
            }

            async function doLogin() {
                const user = document.getElementById('login-user').value.trim();
                const pass = document.getElementById('login-pass').value;
                const hash = await sha256(user + ':' + pass);
                if (hash === HASH) {
                    sessionStorage.setItem('mp_auth', HASH);
                    overlay.classList.add('hidden');
                    setTimeout(() => overlay.style.display = 'none', 400);
                } else {
                    document.getElementById('login-error').textContent = 'ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯';
                }
            }

            document.getElementById('login-btn').addEventListener('click', doLogin);
            document.getElementById('login-pass').addEventListener('keypress', e => {
                if (e.key === 'Enter') doLogin();
            });
        })();
    </script>

    <div id="phone-screen" class="dark-mode">
        <!-- çŠ¶æ€æ  -->
        <div id="status-bar">
            <span id="status-bar-time">12:00</span>
            <div id="status-bar-battery" class="battery-container">
                <span class="battery-text">--%</span>
                <div class="battery-icon">
                    <div class="battery-level"></div>
                </div>
            </div>
        </div>

        <!-- ========== ä¸»å±å¹• ========== -->
        <div id="home-screen" class="screen active">
            <div id="home-clock-container">
                <div id="home-main-time">12:00</div>
                <div id="home-main-date">1æœˆ1æ—¥ æ˜ŸæœŸä¸€</div>
            </div>
            <div id="desktop-app-container">
                <div class="desktop-app-icon" onclick="openChatList()">
                    <div class="icon-bg-desktop">ğŸ’¬</div>
                    <span class="label">æ¶ˆæ¯</span>
                </div>
                <div class="desktop-app-icon" onclick="showScreen('moments-screen')">
                    <div class="icon-bg-desktop">ğŸ“·</div>
                    <span class="label">æœ‹å‹åœˆ</span>
                </div>
                <div class="desktop-app-icon" onclick="openSummaryApp()">
                    <div class="icon-bg-desktop">ğŸ“š</div>
                    <span class="label">AI æ€»ç»“</span>
                </div>
                <div class="desktop-app-icon" onclick="openCharacterSelector()">
                    <div class="icon-bg-desktop">ğŸ“±</div>
                    <span class="label">CPhone</span>
                </div>
                <div class="desktop-app-icon" onclick="showScreen('api-settings-screen')">
                    <div class="icon-bg-desktop">âš™ï¸</div>
                    <span class="label">APIè®¾ç½®</span>
                </div>
                <div class="desktop-app-icon"
                    ontouchstart="if(window.openGlobalPromptSettings) window.openGlobalPromptSettings()"
                    onclick="if(window.openGlobalPromptSettings) window.openGlobalPromptSettings()">
                    <div class="icon-bg-desktop">ğŸ“–</div>
                    <span class="label">ä¸–ç•Œä¹¦</span>
                </div>
            </div>
        </div>

        <!-- ========== èŠå¤©åˆ—è¡¨ ========== -->
        <div id="summary-app-screen" class="screen">
            <div class="header">
                <span class="back-btn" onclick="showScreen('home-screen')">â€¹</span>
                <span>AI æ€»ç»“</span>
                <span style="width: 30px;"></span>
            </div>
            <div id="summary-list" class="list-container"></div>
        </div>

        <!-- ========== æ€»ç»“è¯¦æƒ…ç•Œé¢ ========== -->
        <div id="summary-detail-screen" class="screen">
            <div class="header">
                <span class="back-btn" onclick="showScreen('summary-app-screen')">â€¹</span>
                <span id="summary-detail-title">æ€»ç»“è®°å½•</span>
                <span style="width: 30px;"></span>
            </div>
            <div id="summary-content" class="moment-content"
                style="padding: 20px; white-space: pre-wrap; user-select: text;"></div>
        </div>
        <!-- ========== èŠå¤©åˆ—è¡¨ ========== -->
        <div id="chat-list-screen" class="screen">
            <div class="header">
                <span class="back-btn" onclick="showScreen('home-screen')">â€¹</span>
                <span>æ¶ˆæ¯</span>
                <span class="action-btn" id="add-chat-btn">+</span>
            </div>
            <div id="chat-list" class="list-container"></div>
        </div>

        <!-- ========== èŠå¤©ç•Œé¢ ========== -->
        <div id="chat-interface-screen" class="screen">
            <div class="header" style="position:relative;">
                <span class="back-btn" id="back-to-list-btn">â€¹</span>
                <span id="chat-header-title">èŠå¤©å¯¹è±¡</span>
                <span class="action-btn" id="chat-menu-btn">â‹¯</span>
                <div class="chat-dropdown-menu" id="chat-dropdown-menu">
                    <div class="chat-dropdown-item" id="menu-chat-settings">
                        <span class="icon">ğŸ‘¤</span><span>è§’è‰²ä¿¡æ¯</span>
                    </div>
                    <div class="chat-dropdown-item" id="menu-transfer">
                        <span class="icon">ğŸ’°</span><span>è½¬è´¦</span>
                    </div>
                </div>
            </div>
            <div id="chat-messages"></div>
            <div id="typing-indicator">å¯¹æ–¹æ­£åœ¨è¾“å…¥...</div>
            <div id="emoji-panel">
                <div class="emoji-tabs">
                    <span class="emoji-tab active" data-category="smileys">ğŸ˜€</span>
                    <span class="emoji-tab" data-category="gestures">ğŸ‘‹</span>
                    <span class="emoji-tab" data-category="hearts">â¤ï¸</span>
                    <span class="emoji-tab" data-category="animals">ğŸ±</span>
                    <span class="emoji-tab" data-category="food">ğŸ”</span>
                    <span class="emoji-tab" data-category="objects">âš½</span>
                </div>
                <div class="emoji-grid" id="emoji-grid"></div>
            </div>
            <div id="chat-input-area">
                <button id="emoji-btn" title="è¡¨æƒ…">ğŸ˜Š</button>
                <textarea id="chat-input" rows="1" placeholder="è¾“å…¥æ¶ˆæ¯..."></textarea>
                <div id="input-actions">
                    <button id="wait-reply-btn" title="å‘é€ä½†ä¸ç­‰å¾…AIå›å¤">âœ‹</button>
                    <button id="send-btn">å‘é€</button>
                </div>
            </div>
        </div>

        <!-- ========== æ·»åŠ èŠå¤©å¼¹çª— ========== -->
        <div id="add-chat-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header"><span>æ·»åŠ è”ç³»äºº</span></div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>å¤´åƒ</label>
                        <div class="avatar-upload-group">
                            <img id="new-chat-avatar-preview" class="avatar-preview-img" style="display:none">
                            <div class="avatar-input-row">
                                <input type="text" id="new-chat-avatar" placeholder="å›¾ç‰‡URL æˆ– ä¸Šä¼ å›¾ç‰‡">
                                <input type="file" id="new-chat-file" accept="image/*" style="display:none"
                                    onchange="handleAvatarUpload(this, 'new-chat-avatar', 'new-chat-avatar-preview')">
                                <button class="upload-btn"
                                    onclick="document.getElementById('new-chat-file').click()">ğŸ“‚</button>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>åç§°</label>
                        <input type="text" id="new-chat-name" placeholder="è¾“å…¥åç§°...">
                    </div>
                    <div class="form-group">
                        <label>äººè®¾æè¿°</label>
                        <textarea id="new-chat-persona" rows="4" placeholder="æè¿°è¿™ä¸ªè§’è‰²çš„æ€§æ ¼ã€èƒŒæ™¯..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="cancel" id="cancel-add-chat-btn">å–æ¶ˆ</button>
                    <button class="save" id="confirm-add-chat-btn">æ·»åŠ </button>
                </div>
            </div>
        </div>

        <!-- ========== èŠå¤©è®¾ç½®å¼¹çª— ========== -->
        <div id="chat-settings-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header"><span>èŠå¤©è®¾ç½®</span></div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>å¤´åƒ</label>
                        <div class="avatar-upload-group">
                            <img id="edit-chat-avatar-preview" class="avatar-preview-img" style="display:none">
                            <div class="avatar-input-row">
                                <input type="text" id="edit-chat-avatar" placeholder="å›¾ç‰‡URL æˆ– ä¸Šä¼ å›¾ç‰‡">
                                <input type="file" id="edit-chat-file" accept="image/*" style="display:none"
                                    onchange="handleAvatarUpload(this, 'edit-chat-avatar', 'edit-chat-avatar-preview')">
                                <button class="upload-btn"
                                    onclick="document.getElementById('edit-chat-file').click()">ğŸ“‚</button>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>åç§°</label>
                        <input type="text" id="edit-chat-name" placeholder="è¾“å…¥åç§°...">
                    </div>
                    <div class="form-group">
                        <label>äººè®¾æè¿°</label>
                        <textarea id="edit-chat-persona" rows="4" placeholder="æè¿°è¿™ä¸ªè§’è‰²çš„æ€§æ ¼ã€èƒŒæ™¯..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="cancel" id="cancel-chat-settings-btn">å–æ¶ˆ</button>
                    <button class="action" id="clear-chat-data-btn"
                        style="background:#ff9800;color:white;margin-right:10px;">æ¸…é™¤æ•°æ®</button>
                    <button class="delete" id="delete-chat-btn">åˆ é™¤</button>
                    <button class="save" id="save-chat-settings-btn">ä¿å­˜</button>
                </div>
            </div>
        </div>

        <!-- ========== è½¬è´¦å¼¹çª— ========== -->
        <div id="transfer-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header"><span>è½¬è´¦</span></div>
                <div class="modal-body">
                    <input type="number" id="transfer-amount" placeholder="Â¥ é‡‘é¢" step="0.01" min="0.01">
                    <input type="text" id="transfer-note" placeholder="æ·»åŠ è½¬è´¦è¯´æ˜...">
                </div>
                <div class="modal-footer">
                    <button class="cancel" id="cancel-transfer-btn">å–æ¶ˆ</button>
                    <button class="save" id="confirm-transfer-btn"
                        style="background:linear-gradient(135deg,#f0a03c,#e08c2a);border:none;">è½¬è´¦</button>
                </div>
            </div>
        </div>

        <!-- ========== è½¬è´¦æ“ä½œå¼¹çª— ========== -->
        <div class="transfer-action-overlay" id="transfer-action-overlay">
            <div class="transfer-action-sheet">
                <div class="transfer-action-info">
                    <div class="amount" id="action-transfer-amount">Â¥0.00</div>
                    <div class="note" id="action-transfer-note"></div>
                </div>
                <div class="transfer-action-btns" id="transfer-action-btns">
                </div>
            </div>
        </div>

        <!-- ========== è§’è‰²é€‰æ‹©ç•Œé¢ ========== -->
        <div id="character-selection-screen" class="screen">
            <div class="header">
                <span class="back-btn" onclick="showScreen('home-screen')">â€¹</span>
                <span>é€‰æ‹©ä¸€éƒ¨æ‰‹æœº</span>
                <span class="action-btn" id="add-character-btn">+</span>
            </div>
            <div id="character-grid"></div>
        </div>

        <!-- ========== æ·»åŠ è§’è‰²å¼¹çª— ========== -->
        <div id="add-character-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header"><span>æ·»åŠ è§’è‰²æ‰‹æœº</span></div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>è§’è‰²å¤´åƒ</label>
                        <div class="avatar-upload-group">
                            <img id="new-char-avatar-preview" class="avatar-preview-img" style="display:none">
                            <div class="avatar-input-row">
                                <input type="text" id="new-char-avatar" placeholder="å›¾ç‰‡URL æˆ– ä¸Šä¼ å›¾ç‰‡">
                                <input type="file" id="new-char-file" accept="image/*" style="display:none"
                                    onchange="handleAvatarUpload(this, 'new-char-avatar', 'new-char-avatar-preview')">
                                <button class="upload-btn"
                                    onclick="document.getElementById('new-char-file').click()">ğŸ“‚</button>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>è§’è‰²åç§°</label>
                        <input type="text" id="new-char-name" placeholder="è¾“å…¥è§’è‰²å...">
                    </div>
                    <div class="form-group">
                        <label>è§’è‰²äººè®¾</label>
                        <textarea id="new-char-persona" rows="4" placeholder="æè¿°è¿™ä¸ªè§’è‰²çš„æ€§æ ¼ã€èƒŒæ™¯..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="cancel" id="cancel-add-char-btn">å–æ¶ˆ</button>
                    <button class="save" id="confirm-add-char-btn">æ·»åŠ </button>
                </div>
            </div>
        </div>

        <!-- ========== è§’è‰²æ‰‹æœºç•Œé¢ ========== -->
        <div id="character-phone-screen" class="screen">
            <div id="char-home-screen" class="char-screen active">
                <div id="char-clock-container">
                    <div id="char-main-time">12:00</div>
                    <div id="char-main-date">1æœˆ1æ—¥ æ˜ŸæœŸä¸€</div>
                </div>
                <div id="char-app-grid">
                    <div class="app-row">
                        <div class="app-icon" onclick="openCharApp('qq')">
                            <div class="icon-bg">ğŸ’¬</div>
                            <span class="label">å¾®ä¿¡</span>
                        </div>
                        <div class="app-icon" onclick="openCharApp('album')">
                            <div class="icon-bg">ğŸ–¼ï¸</div>
                            <span class="label">ç›¸å†Œ</span>
                        </div>
                        <div class="app-icon" onclick="openCharApp('memo')">
                            <div class="icon-bg">ğŸ“</div>
                            <span class="label">å¤‡å¿˜å½•</span>
                        </div>
                        <div class="app-icon" onclick="switchToMyPhone()">
                            <div class="icon-bg">ğŸ </div>
                            <span class="label">è¿”å›</span>
                        </div>
                    </div>
                    <div class="app-row">
                        <div class="app-icon" onclick="openCharApp('browser')">
                            <div class="icon-bg">ğŸŒ</div>
                            <span class="label">æµè§ˆå™¨</span>
                        </div>
                        <div class="app-icon" onclick="openCharApp('sms')">
                            <div class="icon-bg">âœ‰ï¸</div>
                            <span class="label">çŸ­ä¿¡</span>
                        </div>
                        <div class="app-icon" onclick="openCharApp('x')">
                            <div class="icon-bg" style="font-weight:900;font-family:serif;">ğ•</div>
                            <span class="label">X</span>
                        </div>
                        <div class="app-icon" onclick="openCharApp('calculator')">
                            <div class="icon-bg">ğŸ”¢</div>
                            <span class="label">è®¡ç®—å™¨</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- è§’è‰²å¾®ä¿¡ç•Œé¢ -->
            <div id="char-qq-screen" class="char-screen">
                <div class="header">
                    <span class="back-btn" onclick="switchToCharHomeScreen()">â€¹</span>
                    <span>å¾®ä¿¡</span>
                    <span class="action-btn" id="regenerate-char-qq-btn">ğŸ”„</span>
                </div>
                <div id="char-chat-list" class="list-container"></div>
            </div>

            <!-- è§’è‰²ç›¸å†Œç•Œé¢ -->
            <div id="char-album-screen" class="char-screen">
                <div class="header">
                    <span class="back-btn" onclick="switchToCharHomeScreen()">â€¹</span>
                    <span>TAçš„ç›¸å†Œ</span>
                    <span class="action-btn" id="regenerate-char-album-btn">ğŸ”„</span>
                </div>
                <div id="char-album-grid" class="list-container"></div>
            </div>

            <!-- è§’è‰²å¤‡å¿˜å½•ç•Œé¢ -->
            <div id="char-memo-screen" class="char-screen">
                <div class="header">
                    <span class="back-btn" onclick="switchToCharHomeScreen()">â€¹</span>
                    <span>å¤‡å¿˜å½•</span>
                    <span class="action-btn" id="regenerate-char-memo-btn">ğŸ”„</span>
                </div>
                <div id="char-memo-list" class="list-container"></div>
            </div>

            <!-- è§’è‰²æµè§ˆå™¨ç•Œé¢ -->
            <div id="char-browser-screen" class="char-screen">
                <div class="header">
                    <span class="back-btn" onclick="switchToCharHomeScreen()">â€¹</span>
                    <span>æµè§ˆå™¨</span>
                    <span class="action-btn" id="regenerate-char-browser-btn">ğŸ”„</span>
                </div>
                <div id="char-browser-content" class="list-container"></div>
            </div>

            <!-- è§’è‰²çŸ­ä¿¡ç•Œé¢ -->
            <div id="char-sms-screen" class="char-screen">
                <div class="header">
                    <span class="back-btn" onclick="switchToCharHomeScreen()">â€¹</span>
                    <span>çŸ­ä¿¡</span>
                    <span class="action-btn" id="regenerate-char-sms-btn">ğŸ”„</span>
                </div>
                <div id="char-sms-list" class="list-container"></div>
            </div>

            <!-- è§’è‰² X ç•Œé¢ -->
            <div id="char-x-screen" class="char-screen">
                <div class="header">
                    <span class="back-btn" onclick="switchToCharHomeScreen()">â€¹</span>
                    <span style="font-weight:900;font-family:serif;">ğ•</span>
                    <span class="action-btn" id="regenerate-char-x-btn">ğŸ”„</span>
                </div>
                <div id="char-x-feed" class="list-container"></div>
            </div>

            <!-- è§’è‰²è®¡ç®—å™¨ç•Œé¢ -->
            <div id="char-calculator-screen" class="char-screen">
                <div class="calculator-display" id="calc-display">0</div>
                <div class="calculator-keyboard">
                    <div class="calc-row">
                        <button class="calc-btn op" onclick="calcInput('C')">C</button>
                        <button class="calc-btn op" onclick="calcInput('Â±')">Â±</button>
                        <button class="calc-btn op" onclick="calcInput('%')">%</button>
                        <button class="calc-btn op-orange" onclick="calcInput('/')">Ã·</button>
                    </div>
                    <div class="calc-row">
                        <button class="calc-btn" onclick="calcInput('7')">7</button>
                        <button class="calc-btn" onclick="calcInput('8')">8</button>
                        <button class="calc-btn" onclick="calcInput('9')">9</button>
                        <button class="calc-btn op-orange" onclick="calcInput('*')">Ã—</button>
                    </div>
                    <div class="calc-row">
                        <button class="calc-btn" onclick="calcInput('4')">4</button>
                        <button class="calc-btn" onclick="calcInput('5')">5</button>
                        <button class="calc-btn" onclick="calcInput('6')">6</button>
                        <button class="calc-btn op-orange" onclick="calcInput('-')">-</button>
                    </div>
                    <div class="calc-row">
                        <button class="calc-btn" onclick="calcInput('1')">1</button>
                        <button class="calc-btn" onclick="calcInput('2')">2</button>
                        <button class="calc-btn" onclick="calcInput('3')">3</button>
                        <button class="calc-btn op-orange" onclick="calcInput('+')">+</button>
                    </div>
                    <div class="calc-row">
                        <button class="calc-btn zero" onclick="calcInput('0')">0</button>
                        <button class="calc-btn" onclick="calcInput('.')">.</button>
                        <button class="calc-btn op-orange" onclick="calcInput('=')">=</button>
                    </div>
                    <div style="width:100%;text-align:center;margin-top:20px;">
                        <span class="back-btn-calc" onclick="switchToCharHomeScreen()">ğŸ  è¿”å›</span>
                    </div>
                </div>
            </div>

            <!-- ç§å¯†ç›¸å†Œç•Œé¢ -->
            <div id="char-secret-gallery-screen" class="char-screen" style="background:#111;">
                <div class="header" style="background:rgba(0,0,0,0.8);border-bottom:1px solid #333;">
                    <span class="back-btn" onclick="switchToCharHomeScreen()">â€¹</span>
                    <span style="color:#ff4081;font-weight:bold;">Private Gallery</span>
                    <span class="action-btn" id="regenerate-char-secret-gallery-btn">ğŸ”„</span>
                </div>
                <div id="char-secret-gallery-grid" class="list-container"
                    style="padding:15px;display:grid;grid-template-columns:1fr 1fr;gap:15px;"></div>
            </div>
        </div>

        <!-- ========== æœ‹å‹åœˆç•Œé¢ ========== -->
        <div id="moments-screen" class="screen">
            <div class="header">
                <span class="back-btn" onclick="showScreen('home-screen')">â€¹</span>
                <span>æœ‹å‹åœˆ</span>
                <div class="header-actions">
                    <span class="action-btn" id="post-moment-btn" title="å‘æœ‹å‹åœˆ">âœï¸</span>
                    <span class="action-btn" id="generate-moments-btn" title="AIç”ŸæˆåŠ¨æ€">ğŸ”„</span>
                </div>
            </div>
            <div id="moments-list" class="list-container"></div>
        </div>

        <!-- ========== å‘æœ‹å‹åœˆå¼¹çª— ========== -->
        <div id="post-moment-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header"><span>å‘æœ‹å‹åœˆ</span></div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>è¯´ç‚¹ä»€ä¹ˆ...</label>
                        <textarea id="moment-content" rows="4" placeholder="è¿™ä¸€åˆ»çš„æƒ³æ³•..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="cancel" id="cancel-post-moment-btn">å–æ¶ˆ</button>
                    <button class="save" id="confirm-post-moment-btn">å‘å¸ƒ</button>
                </div>
            </div>
        </div>

        <!-- ========== API è®¾ç½®ç•Œé¢ ========== -->
        <div id="api-settings-screen" class="screen">
            <div class="header">
                <span class="back-btn" onclick="showScreen('home-screen')">â€¹</span>
                <span>API è®¾ç½®</span>
                <span style="width: 30px;"></span>
            </div>
            <div class="form-container">
                <h3>ä¸»APIè®¾ç½®</h3>
                <div class="form-group">
                    <label for="proxy-url">åä»£åœ°å€ (ä¸éœ€è¦æ·»åŠ /v1)</label>
                    <input type="text" id="proxy-url" placeholder="ä¾‹å¦‚: https://api.openai.com">
                </div>
                <div class="form-group">
                    <label for="api-key">API Key</label>
                    <input type="password" id="api-key" placeholder="sk-...">
                </div>
                <div class="form-group">
                    <label for="model-select">æ¨¡å‹</label>
                    <select id="model-select">
                        <option value="gpt-4o-mini">gpt-4o-mini</option>
                        <option value="gpt-4o">gpt-4o</option>
                        <option value="gpt-3.5-turbo">gpt-3.5-turbo</option>
                    </select>
                </div>
                <button class="form-button" id="fetch-models-btn">æ‹‰å–æ¨¡å‹åˆ—è¡¨</button>

                <hr>

                <h3>ç”¨æˆ·è®¾ç½®</h3>
                <div class="form-group">
                    <label for="user-name-input">ä½ çš„åå­—</label>
                    <input type="text" id="user-name-input" placeholder="ç”¨æˆ·">
                </div>
                <div class="form-group">
                    <label>ç”¨æˆ·å¤´åƒ</label>
                    <div class="avatar-upload-group">
                        <img id="user-avatar-preview" class="avatar-preview-img" style="display:none">
                        <div class="avatar-input-row">
                            <input type="text" id="user-avatar-input" placeholder="å›¾ç‰‡URL æˆ– ä¸Šä¼ å›¾ç‰‡">
                            <input type="file" id="user-avatar-file" accept="image/*" style="display:none"
                                onchange="handleAvatarUpload(this, 'user-avatar-input', 'user-avatar-preview')">
                            <button class="upload-btn"
                                onclick="document.getElementById('user-avatar-file').click()">ğŸ“‚</button>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label>ç”¨æˆ·ç®€ä»‹</label>
                    <textarea id="user-bio-input" rows="3" placeholder="å‘Šè¯‰AIå…³äºä½ çš„ä¿¡æ¯ï¼ˆèŒä¸šã€çˆ±å¥½ç­‰ï¼‰ï¼Œè®©å›å¤æ›´è´´åˆ..."></textarea>
                </div>

                <button class="form-button save-btn" id="save-api-settings-btn">ä¿å­˜è®¾ç½®</button>

                <hr style="margin: 30px 0;">

                <h3>æ•°æ®ç®¡ç†</h3>
                <div class="form-group">
                    <div style="font-size:12px;color:var(--text-secondary);margin-bottom:8px;">åŒ…å«æ‰€æœ‰èŠå¤©è®°å½•ã€è§’è‰²ã€è‡ªå®šä¹‰è¡¨æƒ…åŒ…åŠè®¾ç½®
                    </div>
                    <button class="form-button" id="export-data-btn" style="background:var(--bg-tertiary);">â¬‡ï¸
                        å¯¼å‡ºå…¨é‡å¤‡ä»½</button>
                    <button class="form-button" id="import-data-btn"
                        style="background:var(--bg-tertiary);margin-top:8px;">â¬†ï¸ å¯¼å…¥å…¨é‡å¤‡ä»½</button>
                    <input type="file" id="import-file" style="display:none" accept=".json">
                    <button class="form-button" onclick="window.diagnoseData()"
                        style="background:#4a148c;margin-top:10px;font-size:12px;">ğŸ› ï¸ æ•°æ®è¯Šæ–­ (é‡åˆ°é—®é¢˜ç‚¹æˆ‘)</button>
                </div>

                <hr style="margin: 30px 0;">

                <h3>å…³äº</h3>
                <div class="form-group">
                    <div
                        style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;font-size:14px;">
                        <span>å½“å‰ç‰ˆæœ¬</span>
                        <span style="color:#888;">v39 (Secret Calc)</span>
                    </div>
                    <button class="form-button" id="check-update-btn" style="background:#546e7a;">
                        æ£€æŸ¥æ›´æ–° / å¼ºåˆ¶åˆ·æ–°
                    </button>
                    <div style="font-size:12px;color:#999;margin-top:8px;text-align:center;">
                        å¦‚æœé‡åˆ°åŠŸèƒ½å¼‚å¸¸æˆ–å†…å®¹ä¸æ›´æ–°ï¼Œè¯·ç‚¹å‡»å…¨é‡åˆ·æ–°
                    </div>
                </div>
            </div>
        </div>

    </div>
    <!-- Global System Prompt Settings Modal -->
    <div id="global-prompt-modal" class="modal">
        <div class="modal-content">
            <h3 class="modal-title">ä¸–ç•Œä¹¦è®¾å®š</h3>
            <div class="form-group">
                <label>ä¸–ç•Œä¹¦ (World Book)</label>
                <div style="font-size:12px;color:var(--text-secondary);margin-bottom:8px;">ä¸–ç•Œä¹¦å†…å®¹å°†åº”ç”¨äºæ‰€æœ‰è§’è‰²ï¼Œç”¨äºè®¾å®šä¸–ç•Œè§‚æˆ– AI
                    å›å¤é£æ ¼ï¼ˆå¦‚å¼ºåˆ¶çŸ­å›å¤ã€å¾®ä¿¡é£æ ¼ç­‰ï¼‰ã€‚</div>
                <textarea id="global-system-prompt" class="form-input" rows="8"
                    placeholder="ä¾‹å¦‚ï¼šè¯·å®Œå…¨æ¨¡æ‹Ÿå¾®ä¿¡èŠå¤©é£æ ¼ï¼Œå›å¤ç®€çŸ­..."></textarea>
            </div>
            <div class="modal-buttons">
                <button class="form-button secondary" id="cancel-global-prompt-btn">å–æ¶ˆ</button>
                <button class="form-button primary" id="save-global-prompt-btn">ä¿å­˜</button>
            </div>
            <div class="modal-buttons" style="margin-top:10px;">
                <button class="form-button" id="reset-global-prompt-btn"
                    style="background:var(--bg-secondary);color:var(--text-secondary);">æ¢å¤é»˜è®¤å¾®ä¿¡é£æ ¼</button>
            </div>
        </div>
    </div>
</body>

</html>